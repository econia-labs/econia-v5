\documentclass[table, twocolumn]{article}
\usepackage{amsmath}
\usepackage{geometry}
\usepackage[acronym]{glossaries}
\usepackage{pgfplots}
\usepackage{xcolor}
\pgfplotsset{compat=1.18}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{intersections}

% Page options.
\pagecolor{black}
\color{gray}
\geometry{left=50pt, top=50pt, bottom=50pt, right=50pt}

\input{figures/tangent-line-style.tex}

\newacronym{cpamm}{CPAMM}{Constant Product Automated Market Maker}
\newacronym{lp}{LP}{Liquidity Provider}

% Image in title per https://tex.stackexchange.com/a/251410.
\title{%
  \includegraphics[width=4in]{../../../../.assets/white-econia-primary-logo.png}\\[10pt]
  A Novel Concentrated Liquidity Automated Market Maker
}
\author{Econia Labs}
\date{}

\begin{document}

\maketitle

\section{Base, quote, and price}

Consider the trading pair \texttt{APT/USDC}, \texttt{APT} denominated in \texttt{USDC},
denoted per table \ref{tab:base-quote-definition}.

\begin{table}[!htb]
  \centering
  \begin{tabular}{|c|c|c|}
    \hline \rowcolor{blue}
    Term        & Notation & Example       \\ \hline
    Base asset  & $b$      & \texttt{APT}  \\ \hline
    Quote asset & $q$      & \texttt{USDC} \\ \hline
  \end{tabular}
  \caption{Base and quote asset definitions}
  \label{tab:base-quote-definition}
\end{table}

Equation \ref{eqn:price} defines price as the amount of quote per base, for example
17.27 \texttt{USDC} per \texttt{APT} at the time of this writing.

\begin{equation} \label{eqn:price}
  p = \frac{q}{b}
\end{equation}

\section{Constant product automated market makers}

\subsection{Swap without fees}

A \gls{cpamm} pools together base and quote reserves, with the spot price of the pool
defined as the ratio of quote to base per equation \ref{eqn:price}.

During a swap, either base or quote is provided to the pool in exchange for the other
asset, resulting in a change to the spot price. Per table
\ref{tab:spot-before-after-swap} and equation \ref{eqn:price-before-after} spot prices
are defined before and after in terms of current pool reserves.

\begin{table}[!htb]
  \centering
  \begin{tabular}{|c|c|c|}
    \hline \rowcolor{blue}
    Term           & Before swap & After swap \\ \hline
    Base reserves  & $b_0$       & $b_f$      \\ \hline
    Quote reserves & $q_0$       & $q_f$      \\ \hline
    Spot price     & $p_0$       & $p_f$      \\ \hline
  \end{tabular}
  \caption{Spot price definitions}
  \label{tab:spot-before-after-swap}
\end{table}

\begin{equation} \label{eqn:price-before-after}
  p_0 = \frac{q_0}{b_0},
  p_f = \frac{q_f}{b_f}
\end{equation}

During a swap, a \gls{cpamm} maintains the invariant described in equation
\ref{eqn:cpamm-invariant}.

\begin{equation} \label{eqn:cpamm-invariant}
  b q = L^2
\end{equation}

That is, liquidity $L = \sqrt{bq}$ is held constant during a swap, which means that per
equation \ref{eqn:cpamm-invariant-as-products} the product of base and quote is
equivalent before and after the swap.

\begin{equation} \label{eqn:cpamm-invariant-as-products}
  b_0 q_0 = b_f q_f
\end{equation}

\begin{figure}[!htb]
  \centering
  \input{figures/cpamm-swap-sell.tex}
  \caption{\gls{cpamm} swap sell}
  \label{fig:cpamm-swap-sell}
\end{figure}

As described in table \ref{tab:swap-in-out} and figure \ref{fig:cpamm-swap-sell}, a swap
sell with $b_{in}$ of base provided to the pool results in $q_{out}$ received in return.
Per equation \ref{eqn:cpamm-avg-execution-price}, this operation has average execution
price $p_{sell}$.

\begin{table}[!htb]
  \centering
  \begin{tabular}{|c|c|c|}
    \hline \rowcolor{blue}
    Term  & Swap input & Swap output \\ \hline
    Base  & $b_{in}$   & $b_{out}$   \\ \hline
    Quote & $q_{in}$   & $q_{out}$   \\ \hline
  \end{tabular}
  \caption{Swap input and output definitions}
  \label{tab:swap-in-out}
\end{table}

\begin{equation} \label{eqn:cpamm-avg-execution-price}
  p_{sell} = \frac{q_{out}}{b_{in}}
\end{equation}

Notably, this average execution price (the slope of the secant line between $p_0$ and
$p_f$ in figure \ref{fig:cpamm-swap-sell-price}) lies between the spot price before and
after the swap, $p_0$ and $p_f$, respectively.

\begin{figure}[!htb]
  \centering
  \input{figures/cpamm-swap-sell-price.tex}
  \caption{\gls{cpamm} swap sell execution price}
  \label{fig:cpamm-swap-sell-price}
\end{figure}

Given the constant product invariant from equations \ref{eqn:cpamm-invariant} and
\ref{eqn:cpamm-invariant-as-products}, the output amount of a swap buy or sell is a
direct function of input amount and initial reserves, as described in equation
\ref{eqn:b-q-out-simple} (full derivation at equation
\ref{eqn:b-q-out-simple-derivation}).

\begin{align} \label{eqn:b-q-out-simple}
  b_{out} = \frac{q_{in} b_0}{q_{in} + q_0}, q_{out} = \frac{b_{in} q_0}{b_{in} + b_0}
\end{align}

\subsection{Swap with fees}

Consider a pool fee rate $f_p$ assessed on the output of swap, for example 30 basis
points such that $f_p = \frac{30}{10000}$. By assessing a fee on the output amount and
reinvesting it in the pool, spot price slippage decreases and liquidity increases for
each swap.

For example figure \ref{fig:cpamm-swap-sell-with-fee} denotes a swap sell, where
$f_p q_{out}$ is deducted from quote proceeds and reinvested in the pool, thus
increasing available liquidity.

\begin{figure}[!htb]
  \centering
  \input{figures/cpamm-swap-sell-with-fee.tex}
  \caption{\gls{cpamm} swap sell with fee reinvestment}
  \label{fig:cpamm-swap-sell-with-fee}
\end{figure}

\subsection{Liquidity provider tokens}

As the amount of liquidity in the pool grows so does the share of each \gls{lp} who
holds \gls{lp} tokens in the pool, which represent a share of the pool's liquidity.

Notably, the first \gls{lp} in the pool sets the spot price via the amount of base and
quote contributed, and receives a number of tokens equal to the amount of provided
liquidity.

For example consider the initial base and quote contributions in table
\ref{tab:first-lp-amounts}.  Per equation \ref{eqn:price}, the initial spot price is
then $p = 4$ as shown in equation \ref{eqn:first-lp-spot-price}.

\begin{table}[!htb]
  \centering
  \begin{tabular}{|c|c|c|}
    \hline \rowcolor{blue}
    Asset & Notation & Amount \\ \hline
    Base  & $b$      & 5      \\ \hline
    Quote & $q$      & 20     \\ \hline
  \end{tabular}
  \caption{Base and quote provided by first \gls{lp}}
  \label{tab:first-lp-amounts}
\end{table}

\begin{equation} \label{eqn:first-lp-spot-price}
  p = \frac{q}{b} = \frac{20}{5} = 4
\end{equation}

Per equation \ref{eqn:cpamm-invariant}, the \gls{lp} then receives 10 \gls{lp} tokens as
shown in equation \ref{eqn:first-lp-tokens}.

\begin{equation} \label{eqn:first-lp-tokens}
  L = \sqrt{5 \cdot 20} = 10
\end{equation}

Thereafter any new \gls{lp} must provide base and quote proportional to the amount of
base and quote in the pool at the time of deposit. For example if the spot price does
not change then a new \gls{lp} may contribute another 10 base and 40 quote, as described
in table \ref{tab:new-lp-base-quote-ratios} and equation
\ref{eqn:new-lp-base-quote-ratios}.

\begin{table}[!htb]
  \centering
  \begin{tabular}{|c|c|c|}
    \hline \rowcolor{blue}
    Term            & Notation      & Amount \\ \hline
    Base in pool    & $b_{pool}$    & 5      \\ \hline
    Quote in pool   & $q_{pool}$    & 20     \\ \hline
    Base deposited  & $b_{deposit}$ & 10     \\ \hline
    Quote deposited & $q_{deposit}$ & 40     \\ \hline
  \end{tabular}
  \caption{Base and quote ratios for second \gls{lp}}
  \label{tab:new-lp-base-quote-ratios}
\end{table}

\begin{align} \label{eqn:new-lp-base-quote-ratios}
  \frac{b_{deposit}}{b_{pool}} & \stackrel{?}{=}
  \frac{q_{deposit}}{q_{pool}} \nonumber         \\
  \frac{10}{5}                 & \stackrel{?}{=}
  \frac{40}{20}  \nonumber                       \\
  2                            & = 2
\end{align}

In exchange the new \gls{lp} receives \gls{lp} tokens representing their pro rata share
of the pool's liquidity. Continuing the example, as described in table
\ref{tab:new-lp-tokens} and equation \ref{eqn:new-lp-tokens}, the second \gls{lp} thus
receives 20 \gls{lp} tokens in return.

\begin{table}[!htb]
  \centering
  \begin{tabular}{|c|c|c|}
    \hline \rowcolor{blue}
    Term                           & Notation & Amount \\ \hline
    Existing \gls{lp} token supply & $T_s$    & 10     \\ \hline
    New \gls{lp} tokens issued     & $T_n$    & 20     \\ \hline
  \end{tabular}
  \caption{\gls{lp} token amounts during second contribution}
  \label{tab:new-lp-tokens}
\end{table}

\begin{equation} \label{eqn:new-lp-tokens}
  T_n = \frac{b_{deposit}}{b_{pool}} T_s = \frac{10}{5} 10 = 20
\end{equation}

As the pool processes trades and accumulates fees, the spot price may change as
liquidity grows.  For example consider that over time the amount of liquidity in the
pool increases and price drops by 50\%, yielding a pool with 30 base and 60 quote, as
described in table \ref{tab:pool-reserve-progression}.

\begin{table}[!htb]
  \centering
  \begin{tabular}{|c|c|c|}
    \hline \rowcolor{blue}
    Stage                              & $b_{pool}$ & $q_{pool}$ \\ \hline
    After first \gls{lp} contribution  & 5          & 20         \\ \hline
    After second \gls{lp} contribution & 15         & 60         \\ \hline
    After market activity              & 30         & 60         \\ \hline
  \end{tabular}
  \caption{Pool reserves over time}
  \label{tab:pool-reserve-progression}
\end{table}

Each \gls{lp} is still entitled to a pro rata portion of liquidity in the pool based on
their share of total \gls{lp} tokens issued, as described in table
\ref{tab:lp-pro-rata-shares}.

\begin{table}[!htb]
  \centering
  \begin{tabular}{|c|c|c|c|}
    \hline \rowcolor{blue}
    Provider & Tokens & Base share & Quote share \\ \hline
    First    & 10     & 10         & 20          \\ \hline
    Second   & 20     & 20         & 40          \\ \hline
  \end{tabular}
  \caption{Pro rata liquidity shares after market activity}
  \label{tab:lp-pro-rata-shares}
\end{table}

Notably, Uniswap v2 burns the first 1000 \gls{lp} tokens (equivalent to asset subunits)
to prevent attacks that would enable the first contributor to a pool to make subsequent
liquidity provisioning prohibitively expensive.

\section{Concentrated liquidity equations}

Concentrated liquidity effectively shifts a virtual constant product curve with base
reserves $b_v$ and quote reserves $q_v$ such that real reserves are exhausted at the
price endpoints of a position in range $[p_l, p_h]$, where $l$ and $h$ denote the low
and high bounds on range price.

At $p_l$ real reserves are held entirely in base ($b_{max}$) while at $p_h$ real
reserves are held entirely in quote ($q_{max}$), yielding:

\begin{equation} \label{eqn:liquidity-translation}
  (b_r + b_{max})(q_r + q_{max}) = L_v^2 = b_v q_v
\end{equation}

Equation~\ref{eqn:liquidity-translation} is plotted in
figure~\ref{fig:liquidity-translation}.

\begin{figure}[!htb]
  \centering
  \input{figures/curve-translation.tex}
  \caption{Liquidity translation}
  \label{fig:liquidity-translation}
\end{figure}

For a swap that does not move the price outside the specified range, the input and
output amounts for a feeless swap can thus be calculated using equation
~\ref{eqn:b-q-out-simple} applied to virtual reserves $b_v$ and $q_v$:

\begin{equation}
  b_{out} = \frac{q_{in} b_{v, 0}}{q_{in} + q_{v, 0}},
  q_{out} = \frac{b_{in} q_{v, 0}}{b_{in} + b_{v, 0}}
\end{equation}

\appendix

\section{Derivations}

\begin{align} \label{eqn:b-q-out-simple-derivation}
  b_0 q_0               & = b_f q_f \nonumber                                      \\
  b_0 q_0               & = (b_0 - b_{out})(q_0 + q_{in}) \nonumber                \\
  b_0 q_0               & = b_0 q_0 + b_0 q_{in} - b_{out}(q_0 + q_{in}) \nonumber \\
  b_{out}(q_0 + q_{in}) & = b_{0} q_{in} \nonumber                                 \\
  b_{out}               & = \frac{q_{in} b_0}{q_{in} + q_0}, \nonumber             \\
  b_0 q_0               & = b_f q_f \nonumber                                      \\
  b_0 q_0               & = (b_0 + b_{in})(q_0 - q_{out}) \nonumber                \\
  b_0 q_0               & = b_0 q_0 + b_{in} q_0 - q_{out}(b_0 + b_{in}) \nonumber \\
  q_{out}(b_0 + b_{in}) & = b_{in} q_0 \nonumber                                   \\
  q_{out}               & = \frac{b_{in} q_0}{b_{in} + b_0}
\end{align}

\end{document}
